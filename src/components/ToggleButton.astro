---
import DayIcon from "@/assets/day.svg";
import NightIcon from "@/assets/night.svg";
import themeConfig from "@/config";

const {
  light: { background: lightMode },
  dark: { background: darkMode },
} = themeConfig.color;
---

<div>
  <!-- Theme Toggle -->
  <button
    id="theme-toggle-button"
    class="aspect-square w-4 c-secondary active:scale-90 hover:c-primary relative"
    aria-label="Switch light/dark theme"
  >
    <!-- 白天图标 -->
    <DayIcon 
      class="day-icon inset-0 transition-opacity duration-300"
    />
    <!-- 黑夜图标 -->
    <NightIcon 
      class="night-icon inset-0 transition-opacity duration-300"
    />
  </button>
</div>

<!-- Theme Toggle Script >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>> -->
<script
  is:inline
  define:vars={{
    lightMode,
    darkMode,
  }}
>
// 更新图标显示
function updateThemeIcon(isDark) {
  const dayIcon = document.querySelector('.day-icon');
  const nightIcon = document.querySelector('.night-icon');
  
  if (dayIcon && nightIcon) {
    if (isDark) {
      dayIcon.style.display = 'none';
      nightIcon.style.display = 'block';
    } else {
      dayIcon.style.display = 'block';
      nightIcon.style.display = 'none';
    }
  }
}

// Apply theme changes
function applyTheme(isDark) {
  document.documentElement.classList.toggle('dark', isDark);
  
  // 更新图标显示
  updateThemeIcon(isDark);

  // Update meta theme-color tag
  const metaThemeColor = document.head.querySelector('meta[name="theme-color"]');
  if (metaThemeColor && lightMode && darkMode) {
    metaThemeColor.setAttribute('content', isDark ? darkMode : lightMode);
  }

  // Update any other theme-color meta tags
  const appleMetaThemeColor = document.head.querySelector('meta[name="apple-mobile-web-app-status-bar-style"]');
  if (appleMetaThemeColor && lightMode && darkMode) {
    appleMetaThemeColor.setAttribute('content', isDark ? darkMode : lightMode);
  }

  document.body.style.backgroundColor = isDark ? darkMode : lightMode;
  
  localStorage.setItem('theme', isDark ? 'dark' : 'light');
  document.dispatchEvent(new Event('theme-changed'));
}

// 初始化主题
function initializeTheme() {
  const storedTheme = localStorage.getItem('theme');
  const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
  
  // 决定初始主题
  let isDark;
  if (storedTheme) {
    isDark = storedTheme === 'dark';
  } else {
    isDark = prefersDark;
  }
  
  // 应用初始主题
  applyTheme(isDark);
}

// Toggle theme mode
function toggleTheme() {
  const isDark = !document.documentElement.classList.contains('dark');
  applyTheme(isDark);
}

// Handle theme toggle click events
function handleThemeToggleClick(e) {
  const target = e.target instanceof Element ? e.target : null;
  const button = target?.closest('#theme-toggle-button');

  if (!button) {
    return;
  }

  // If reduceMotion is enabled, update theme directly
  if (document.documentElement.classList.contains('reduce-motion')) {
    toggleTheme();
    return;
  }

  // Add temporary markers before view transition
  document.documentElement.style.setProperty('view-transition-name', 'animation-theme-toggle');
  document.documentElement.setAttribute('data-theme-changing', '');

  // Use View Transitions API for theme toggle
  const transition = document.startViewTransition(toggleTheme);

  // Remove temporary markers after view transition
  transition.finished.then(() => {
    document.documentElement.style.removeProperty('view-transition-name');
    document.documentElement.removeAttribute('data-theme-changing');
  });
}

initializeTheme();

// Bind click event to the button
document.addEventListener('click', handleThemeToggleClick);

// Listen to system theme changes in real time
window.matchMedia('(prefers-color-scheme: dark)')
  .addEventListener('change', (event) => {
    const isDark = event.matches;
    // 如果用户没有手动设置主题，则跟随系统
    if (!localStorage.getItem('theme')) {
      applyTheme(isDark);
    }
  });

window.handleThemeChange = toggleTheme;
</script>

<style is:global>
.day-icon,
.night-icon {
  fill: currentColor;
  transition: opacity 0.3s ease, transform 0.3s ease;
}

:root:not(.dark) .day-icon {
  color: #000000;
}

:root.dark .night-icon {
  color: #ffffff;
}

@media (prefers-reduced-motion: no-preference) {
  ::view-transition-group(root) {
    animation-duration: 0.5s;
  }
}

body {
  transition: background-color 0.3s ease;
}
</style>
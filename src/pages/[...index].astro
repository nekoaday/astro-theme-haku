---
// src/pages/[...index].astro
import { lang, themeConfig } from "@/config";
import Layout from "../layouts/Layout.astro";
import { getPinnedArticles, getRegularArticles, groupArticlesByYear } from "@/utils/content";
import AllArticles from "@/components/AllArticles.astro";
import Pagination from "@/components/Pagination.astro";

export async function getStaticPaths() {
  type PathItem = {
    params: { index: string | undefined };
    props: { language: string; page: number; totalPages: number };
  };

  const paths: PathItem[] = [];

  const articles = await getRegularArticles();
  const pageSize = themeConfig.content.pageSize;
  const totalPages = Math.max(1, Math.ceil(articles.length / pageSize));

  for (let page = 1; page <= totalPages; page += 1) {
    paths.push({
      params: { index: page === 1 ? undefined : `page/${page}` },
      props: { language: lang, page, totalPages },
    });
  }

  return paths;
}

const pinnedPosts = await getPinnedArticles();
const articles = await getRegularArticles();
const { page = 1, totalPages = 1 } = Astro.props;
const pageSize = themeConfig.content.pageSize;
const start = (page - 1) * pageSize;
const end = start + pageSize;
const pageArticles = articles.slice(start, end);
const articlesByYear = groupArticlesByYear(pageArticles);
---

<Layout>
  {
    page === 1 && pinnedPosts.length > 0 && (
      <section class="mb-7.5">
        <div class="uno-decorative-line" />
        <AllArticles articles={pinnedPosts} lang={lang} pinned={true} />
      </section>
    )
  }
  {
    [...articlesByYear.entries()].map(([_year, entries]) => (
      <section class="mb-7.5">
        <div class="uno-decorative-line" />
        <AllArticles articles={entries} lang={lang} />
      </section>
    ))
  }
  <Pagination currentPage={page} totalPages={totalPages} basePath="/" />
</Layout>
